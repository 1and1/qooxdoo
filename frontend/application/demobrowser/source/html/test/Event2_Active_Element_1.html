<html>

<head>
  <title>qooxdoo &raquo; Demo Browser</title>
  <script type="text/javascript" src="../../script/demo.js"></script>
  <script type="text/javascript" src="../util.js"></script>
</head>


<body>

  <div id="description">
  document.activeElement test
  </div>

  <p>Try clicking in various things.  The next paragraph should reflect the active element.</p>

  <div id="output">?</div>

  <hr>

  <p>Try <strong>clicking in</strong> or <em>selecting portions of</em> this styled paragraph.</p>

  <p>Try focusing various form elements:</p>

  <textarea id="area" tabindex="0"></textarea>
  <input>
  <input type="checkbox">
  <input type="button" value="button">
  <button>button</button>

	<script type="text/javascript">

qx.Class.define("BasicSample",
{
  extend : qx.application.Basic,

  members :
  {
    main : function()
    {
      this.base(arguments);

      this.setActiveElement(document.body);

      qx.event2.Manager.addListener(document.documentElement, "click", function(e) {
        //console.log(e.getTarget(), e.getType());
        var node = e.getTarget();
        while (node) {
          if (node.tabIndex !== undefined && node.tabIndex >= 0) {
            this.setActiveElement(node);
            return;
          }
          node = node.parentNode;
        }
        this.setActiveElement(document.body);
      }, this);

      qx.event2.Manager.addListener(document.documentElement, "keyup", function(e) {
        if (e.getKeyIdentifier() == "Tab") {
          this.setActiveElement(e.getTarget());
        }
      }, this);

    },


    setActiveElement : function(el)
    {
      if (this._activeElement == el) {
        return;
      }
      this._activeElement = el;
      document.activeElement = el;
      console.log("active element:", el);
    }

  }
});

qx.core.Init.getInstance().setApplication(new BasicSample);


/**
 * Original code
 */
setInterval(check, 200);

function check()
{
  var s = getActiveElement();
  var output = document.getElementById("output")
  if (output)
    output.innerHTML = s; // textContent would be better, but innerHTML is easy and supported by everything
  else
    window.status = "Script in frameset (top) says: " + s;

}

function getActiveElement()
{
  var rv;

  var el = document.activeElement;
  if (!el) {
    rv = "none";
    return rv;
  }

  if (el && el != document.documentElement) {
    var nt;
    try {
      nt = el.nodeType;
    } catch (e) {
      rv = "[no permission]";
      return rv;
    }
    if (!nt) {
      rv = "[unknown]";
    } else if (nt == 1) {
      rv = el.tagName;
    } else if (nt == 3) {
      rv = "textnode"
    } else {
      rv = nt;
    }

    el = el.parentNode;
    while (el && el != document.documentElement) {
      rv += " in ";
      try {
        nt = el.nodeType;
      } catch (e) {
        rv += "[no permission]";
        return rv;
      }
      if (!nt) {
        rv += "[unknown]";
      } else if (nt == 1) {
        rv += el.tagName;
      } else if (nt == 3) {
        rv += "textnode"
      } else {
        rv += nt;
      }

      el = el.parentNode;
    }
  }

  return rv;
}

		</script>
</body>


</html>